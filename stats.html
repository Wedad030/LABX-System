<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>الإحصائيات - LABX</title>
    <link rel="stylesheet" href="style.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .stats-box {
            background: white;
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 4px 10px #00000015;
            margin-bottom: 18px;
            text-align: center;
        }
        .stats-number {
            font-size: 32px;
            font-weight: bold;
            color: #0f766e;
        }
    </style>
</head>


<body class="bg">

<div class="layout">

    <!-- الهيدر -->
    <header class="top-header">
        <div class="top-header-right">
            <img src="labx.jpeg" class="logo-img">
            <div class="brand-text">
                <div class="brand-title">LABX DENTAL</div>
                <div class="brand-sub">الإحصائيات العامة</div>
            </div>
        </div>

        <div class="top-header-left">
            <button onclick="window.location.href='index.html'"
                    class="btn-logout" style="background:#0f766e;">
                رجوع
            </button>
        </div>
    </header>


    <!-- المحتوى -->
    <main class="main-card fade-in">

        <h2 style="text-align:center;margin-bottom:15px;">لوحة الإحصائيات</h2>

        <div class="tiles-grid">

            <div class="stats-box">
                <h3>إجمالي الحالات</h3>
                <div id="totalCases" class="stats-number">0</div>
            </div>

            <div class="stats-box">
                <h3>تحت الإجراء</h3>
                <div id="underProcess" class="stats-number">0</div>
            </div>

            <div class="stats-box">
                <h3>جاهزة للتسليم</h3>
                <div id="readyCases" class="stats-number">0</div>
            </div>

            <div class="stats-box">
                <h3>تم التسليم للعيادة</h3>
                <div id="clinicReceived" class="stats-number">0</div>
            </div>

        </div>


        <h3 style="margin-top:30px;">إحصائيات الأقسام</h3>
        <canvas id="deptChart"></canvas>

        <h3 style="margin-top:40px;">إحصائيات الفنيين</h3>
        <canvas id="techChart"></canvas>

    </main>

</div>


<script>
// ----------------------------------------------------------
// جلب الإعدادات
// ----------------------------------------------------------
let techList = JSON.parse(localStorage.getItem("techList") || "[]");
let deptList = JSON.parse(localStorage.getItem("deptList") || "[]");

// ----------------------------------------------------------
// جلب الحالات
// ----------------------------------------------------------
let cases = JSON.parse(localStorage.getItem("labxNewCases") || "[]");

document.getElementById("totalCases").innerText = cases.length;
document.getElementById("underProcess").innerText = cases.filter(c => c.status === "تحت الإجراء").length;
document.getElementById("readyCases").innerText = cases.filter(c => c.status === "جاهزة").length;
document.getElementById("clinicReceived").innerText = cases.filter(c => c.status === "تم التسليم للعيادة").length;


// ----------------------------------------------------------
// 1) إحصائيات الأقسام (ديناميكية)
// ----------------------------------------------------------
let deptCount = {};
deptList.forEach(d => deptCount[d] = 0);

cases.forEach(c => {
    if (deptCount[c.caseType] !== undefined) {
        deptCount[c.caseType]++;
    }
});

let deptLabels = Object.keys(deptCount);
let deptValues = Object.values(deptCount);

new Chart(document.getElementById("deptChart"), {
    type: 'bar',
    data: {
        labels: deptLabels,
        datasets: [{
            label: 'عدد الحالات',
            data: deptValues,
            backgroundColor: '#0f766e'
        }]
    },
    options: { responsive: true }
});


// ----------------------------------------------------------
// 2) إحصائيات الفنيين (ديناميكية)
// ----------------------------------------------------------
let techCount = {};
techList.forEach(t => techCount[t.name] = 0);

cases.forEach(c => {
    if (techCount[c.technicianName] !== undefined) {
        techCount[c.technicianName]++;
    }
});

let techLabels = Object.keys(techCount);
let techValues = Object.values(techCount);
let techColors = techList.map(t => t.color || "#0f766e");

new Chart(document.getElementById("techChart"), {
    type: 'pie',
    data: {
        labels: techLabels,
        datasets: [{
            data: techValues,
            backgroundColor: techColors
        }]
    },
    options: { responsive: true }
});

</script>

</body>
</html>
