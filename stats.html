<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª - LABX</title>
    <link rel="stylesheet" href="style.css">

    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø±Ø³ÙˆÙ… -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .stat-card {
            background: white;
            padding: 18px;
            border-radius: 14px;
            box-shadow: 0 4px 18px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            text-align: center;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #0f766e;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 14px;
            box-shadow: 0 4px 18px rgba(0,0,0,0.08);
            margin-top: 25px;
        }
    </style>
</head>

<body class="bg">

<script>
// Ø­Ù…Ø§ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
if (localStorage.getItem("labxLogged") !== "true") {
    window.location.href = "login.html";
}
</script>

<div class="layout">

    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
    <header class="top-header">
        <div class="top-header-right">
            <img src="labx.jpeg" class="logo-img">
            <div class="brand-text">
                <div class="brand-title">LABX DENTAL</div>
                <div class="brand-sub">Statistics</div>
            </div>
        </div>

        <div class="top-header-left">
            <button onclick="window.location.href='index.html'" class="btn-logout">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
    </header>


    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
    <main class="main-card fade-in">

        <h2 style="margin-bottom:20px;">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h2>

        <div class="stat-grid">

            <!-- Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ… -->
            <div class="stat-card">
                <div class="stat-number" id="todayCount">0</div>
                <div>Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
            </div>

            <!-- Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ -->
            <div class="stat-card">
                <div class="stat-number" id="weekCount">0</div>
                <div>Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
            </div>

            <!-- Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø´Ù‡Ø± -->
            <div class="stat-card">
                <div class="stat-number" id="monthCount">0</div>
                <div>Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø´Ù‡Ø±</div>
            </div>

            <!-- Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø³Ù†Ø© -->
            <div class="stat-card">
                <div class="stat-number" id="yearCount">0</div>
                <div>Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø³Ù†Ø©</div>
            </div>

        </div>


        <!-- Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ 1 -->
        <div class="chart-container">
            <h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</h3>
            <canvas id="statusChart"></canvas>
        </div>

        <!-- Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ 2 -->
        <div class="chart-container">
            <h3>Ø¥Ù†ØªØ§Ø¬ÙŠØ© Ø§Ù„ÙÙ†ÙŠÙŠÙ†</h3>
            <canvas id="techChart"></canvas>
        </div>

    </main>

</div>



<!-- Firebase + ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
<script type="module">
import { getDocs, collection } 
from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { db } from "./firebase.js";


// -------------------------------
// 1ï¸âƒ£ Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù…Ù† Firebase
// -------------------------------
async function loadStats() {
    const snapshot = await getDocs(collection(db, "cases"));
    const readySnap = await getDocs(collection(db, "readyCases"));
    const archiveSnap = await getDocs(collection(db, "archive"));

    const all = [
        ...snapshot.docs.map(d => ({id:d.id, ...d.data()})),
        ...readySnap.docs.map(d => ({id:d.id, ...d.data()})),
        ...archiveSnap.docs.map(d => ({id:d.id, ...d.data()})),
    ];

    calculateStats(all);
}


// -------------------------------
// 2ï¸âƒ£ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
// -------------------------------
function calculateStats(cases) {
    const today = new Date().toDateString();

    let todayCount = 0;
    let weekCount = 0;
    let monthCount = 0;
    let yearCount = 0;

    let statusCount = {
        "ØªØ­Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡": 0,
        "Ø¬Ø§Ù‡Ø²Ø©": 0,
        "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù„Ù„Ø¹ÙŠØ§Ø¯Ø©": 0
    };

    let techCount = {};

    const now = new Date();

    cases.forEach(c => {
        let created = new Date(c.createdAt);

        // Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…
        if (created.toDateString() === today) todayCount++;

        // Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
        const diffWeek = (now - created) / (1000 * 60 * 60 * 24);
        if (diffWeek <= 7) weekCount++;

        // Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø´Ù‡Ø±
        if (created.getMonth() === now.getMonth()) monthCount++;

        // Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø³Ù†Ø©
        if (created.getFullYear() === now.getFullYear()) yearCount++;

        // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
        if (statusCount[c.status] !== undefined) {
            statusCount[c.status]++;
        }

        // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙÙ†ÙŠÙŠÙ†
        if (techCount[c.technicianName] == null) {
            techCount[c.technicianName] = 0;
        }
        techCount[c.technicianName]++;
    });

    document.getElementById("todayCount").innerText = todayCount;
    document.getElementById("weekCount").innerText = weekCount;
    document.getElementById("monthCount").innerText = monthCount;
    document.getElementById("yearCount").innerText = yearCount;

    drawStatusChart(statusCount);
    drawTechChart(techCount);
}


// -------------------------------
// 3ï¸âƒ£ Ø±Ø³Ù… Ù…Ø®Ø·Ø· Ø§Ù„Ø­Ø§Ù„Ø§Øª
// -------------------------------
function drawStatusChart(statusCount) {
    const ctx = document.getElementById("statusChart");

    new Chart(ctx, {
        type: "pie",
        data: {
            labels: ["ØªØ­Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡", "Ø¬Ø§Ù‡Ø²Ø©", "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"],
            datasets: [{
                data: [
                    statusCount["ØªØ­Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡"],
                    statusCount["Ø¬Ø§Ù‡Ø²Ø©"],
                    statusCount["ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù„Ù„Ø¹ÙŠØ§Ø¯Ø©"]
                ],
                backgroundColor: ["#0ea5e9", "#22c55e", "#f97316"]
            }]
        }
    });
}


// -------------------------------
// 4ï¸âƒ£ Ø±Ø³Ù… Ù…Ø®Ø·Ø· Ø¥Ù†ØªØ§Ø¬ÙŠØ© Ø§Ù„ÙÙ†ÙŠÙŠÙ†
// -------------------------------
function drawTechChart(techCount) {
    const ctx = document.getElementById("techChart");

    new Chart(ctx, {
        type: "bar",
        data: {
            labels: Object.keys(techCount),
            datasets: [{
                label: "Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª",
                data: Object.values(techCount),
                backgroundColor: "#0f766e"
            }]
        }
    });
}


// ØªØ´ØºÙŠÙ„
loadStats();
</script>

</body>
</html>
