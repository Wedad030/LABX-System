<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>QR â€” LABX</title>
    <link rel="stylesheet" href="style.css">

    <!-- Ù…ÙƒØªØ¨Ø© QR -->
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

    <style>
        .qr-box {
            background: white;
            padding: 28px;
            border-radius: 18px;
            box-shadow: 0 12px 35px rgba(0,0,0,0.10);
            text-align: center;
            max-width: 400px;
            margin: 40px auto;
            animation: formAppear 0.7s ease-out forwards;
            opacity: 0;
        }

        .qr-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--green-main);
        }

        .qr-info {
            color: var(--text-muted);
            margin-top: 10px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .qr-img {
            width: 230px;
            height: 230px;
            margin: 12px auto;
            border-radius: 12px;
            border: 3px solid var(--green-main);
            background: #fff;
            padding: 6px;
        }

        .btn-small {
            padding: 10px 16px;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>

<body class="page-enter">

<div class="layout">

    <header class="top-header">
        <div class="top-header-right">
            <img src="labx.jpeg" class="logo-img">
            <div>
                <div class="brand-title">LABX Dental</div>
                <div class="brand-sub">QR Code</div>
            </div>
        </div>

        <div class="top-header-left">
            <button onclick="history.back()" class="btn">Ø±Ø¬ÙˆØ¹</button>
        </div>
    </header>

    <div id="qrBox" class="qr-box">
        <div class="qr-title fade-item">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </div>

</div>


<!-- ğŸ”¥ Firebase -->
<script type="module">
import { db } from "./firebase.js";
import { doc, getDoc } 
from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";


// ğŸ”¹ 1) Ù†Ø£Ø®Ø° ID Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
const params = new URLSearchParams(window.location.search);
const caseId = params.get("id");


// ğŸ”¹ 2) Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©
async function loadCase() {
    const caseRef = doc(db, "cases", caseId);
    const snap = await getDoc(caseRef);

    if (!snap.exists()) {
        document.getElementById("qrBox").innerHTML = `
            <div class='qr-title'>âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…</div>
        `;
        return;
    }

    const data = snap.data();

    // ğŸ”¹ 3) Ø¥Ù†Ø´Ø§Ø¡ QR
    const qr = new QRious({
        value: data.qrValue,
        size: 220,
        level: "H"
    });

    // ğŸ”¹ 4) Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù€ QR
    document.getElementById("qrBox").innerHTML = `
        <div class="qr-title fade-item">ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„Ø©</div>

        <canvas id="qrCanvas" class="qr-img card-medium"></canvas>

        <div class="qr-info fade-item">
            <strong>${data.patientName}</strong><br>
            Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù: ${data.fileNumber} <br>
            Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©: ${data.clinicNumber}
        </div>

        <button class="btn btn-small" onclick="saveQR()">ğŸ’¾ Ø­ÙØ¸ QR</button>
        <button class="btn btn-small" onclick="copyQR()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù‚ÙŠÙ…Ø©</button>
    `;

    const canvas = document.getElementById("qrCanvas");
    canvas.getContext("2d").drawImage(qr.image, 0, 0, 220, 220);
}

loadCase();


// ğŸ”¹ 5) Ø²Ø± Ø­ÙØ¸ QR
window.saveQR = function () {
    const canvas = document.getElementById("qrCanvas");
    const link = document.createElement("a");
    link.download = "labx-qr.png";
    link.href = canvas.toDataURL();
    link.click();
};


// ğŸ”¹ 6) Ù†Ø³Ø® Ù‚ÙŠÙ…Ø© QR
window.copyQR = function () {
    navigator.clipboard.writeText("LABX-" + caseId);
    alert("âœ” ØªÙ… Ù†Ø³Ø® Ø±Ù…Ø² Ø§Ù„Ù€ QR");
};
</script>


</body>
</html>
