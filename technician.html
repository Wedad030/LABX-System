<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ†ÙŠ - LABX</title>
    <link rel="stylesheet" href="style.css">
</head>

<body class="bg">
    <script>
// Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù…
if (localStorage.getItem("labxLogged") !== "true") {
    window.location.href = "login.html";
}
</script>
<div class="layout">

    <!-- Ù‡ÙŠØ¯Ø± Ø§Ù„ØµÙØ­Ø© -->
    <header class="top-header">
        <div class="top-header-right">
            <img src="labx.jpeg" class="logo-img" alt="LABX Dental">
            <div class="brand-text">
                <div class="brand-title">LABX DENTAL</div>
                <div class="brand-sub">Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ†ÙŠ</div>
            </div>
        </div>

        <div class="top-header-left">
            <button onclick="window.location.href='index.html'"
                    class="btn-logout" style="background:#0f766e;">
                Ø±Ø¬ÙˆØ¹
            </button>
        </div>
    </header>


    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© -->
    <main class="main-card fade-in">

        <h2 style="margin-bottom:15px;">Ø§Ù„Ø­Ø§Ù„Ø§Øª ØªØ­Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h2>

        <div id="vacationAlert"
             style="padding:10px;background:#fed7aa;border-radius:10px;color:#b45309;display:none;">
            âš  ÙŠÙˆØ¬Ø¯ ÙÙ†ÙŠ ÙÙŠ Ø¥Ø¬Ø§Ø²Ø© Ø­Ø§Ù„ÙŠØ§Ù‹
        </div>

        <div id="casesContainer" class="tiles-grid"></div>

    </main>

</div>


<script>
// ---------------------------------------------------------
// Ø¬Ù„Ø¨ Ø§Ù„ÙÙ†ÙŠÙŠÙ† + Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
// ---------------------------------------------------------
let techList = JSON.parse(localStorage.getItem("techList") || "[]");
let vacList = JSON.parse(localStorage.getItem("vacList") || "[]");

let cases = JSON.parse(localStorage.getItem("labxNewCases") || "[]");


// ØªØ­ÙˆÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ø¥Ù„Ù‰ Ø®Ø±ÙŠØ·Ø© (Ø§Ø³Ù… â†’ Ù„ÙˆÙ†)
const techColors = {};
techList.forEach(t => {
    techColors[t.name] = t.color;
});


// ---------------------------------------------------------
// Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø§Øª
// ---------------------------------------------------------
function renderCases() {
    const container = document.getElementById("casesContainer");
    container.innerHTML = "";

    const underProcess = cases.filter(c => c.status === "ØªØ­Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡");

    underProcess.forEach(c => {

        // Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„ÙÙ†ÙŠ ÙÙŠ Ø¥Ø¬Ø§Ø²Ø©ØŸ
        let isVacation = vacList.includes(c.technicianName);

        const card = document.createElement("div");
        card.className = "tile";

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„ÙÙ†ÙŠ
        let color = techColors[c.technicianName] || "#0f766e";
        card.style.borderRight = `10px solid ${color}`;

        card.innerHTML = `
            <h3>${c.patientName}</h3>
            <p>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù: ${c.fileNumber}</p>
            <p>Ø§Ù„ÙÙ†ÙŠ: ${c.technicianName}</p>
            <p>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø©: ${c.caseType}</p>
            <p style="font-size:12px;color:#64748b;">ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„: ${c.createdAt}</p>

            ${isVacation ? `<p style="color:#ea580c;font-weight:bold;">âš  Ø§Ù„ÙÙ†ÙŠ ÙÙŠ Ø¥Ø¬Ø§Ø²Ø©</p>` : ""}

            <button onclick="markAsEdited(${c.id})"
                    class="btn-logout" style="background:#0f172a;margin-top:10px;width:100%;">
                ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©
            </button>

            <button onclick="markAsReady(${c.id})"
                    class="btn-logout" style="background:#0f766e;margin-top:10px;width:100%;">
                Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØ³Ù„ÙŠÙ… âœ”
            </button>
        `;

        container.appendChild(card);
    });
}


// ---------------------------------------------------------
// Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©
// ---------------------------------------------------------
function markAsEdited(id) {
    let index = cases.findIndex(c => c.id === id);
    if (index > -1) {
        cases[index].isEdited = true;
        localStorage.setItem("labxNewCases", JSON.stringify(cases));
        alert("âœ” ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø§Ù„Ø© ÙƒØªØ¹Ø¯ÙŠÙ„");
        renderCases();
    }
}


// ---------------------------------------------------------
// Ø¯Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø­Ø§Ù„Ø©
// ---------------------------------------------------------
function markAsReady(id) {
    let index = cases.findIndex(c => c.id === id);
    if (index > -1) {
        cases[index].status = "Ø¬Ø§Ù‡Ø²Ø©";
        cases[index].readyTime = new Date().toLocaleString();

        localStorage.setItem("labxNewCases", JSON.stringify(cases));
        alert("âœ” Ø§Ù„Ø­Ø§Ù„Ø© Ø£ØµØ¨Ø­Øª Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØ³Ù„ÙŠÙ…");
        renderCases();
    }
}


// ---------------------------------------------------------
// ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª
// ---------------------------------------------------------
function checkVacation() {
    if (vacList.length > 0) {
        document.getElementById("vacationAlert").style.display = "block";
    }
}


// ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
renderCases();
checkVacation();

</script>
<!-- ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØµÙØ­Ø© ... -->

<script type="module" src="firebase.js"></script>
<script type="module">
import { getCasesFromCloud, markCaseAsEdited } from "./firebase.js";

const container = document.getElementById("casesContainer");
const vacationAlert = document.getElementById("vacationAlert");

// Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ø¨Ø¹Ø¯ Ø±Ø¨Ø· Firebase
const techColors = {
  "Ù‚Ø§Ø³Ù… Ø¹Ø³ÙŠØ±ÙŠ": { main: "#3bb2f6", edited: "#22c55e" },
  "Ø£Ø­Ù…Ø¯ ÙƒÙˆØ´Ø§Ù†": { main: "#3bb2f6", edited: "#22c55e" },
  "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø´ÙŠØ¯": { main: "#3bb2f6", edited: "#22c55e" },
  "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø´Ù‡Ø±Ø§Ù†ÙŠ": { main: "#3bb2f6", edited: "#22c55e" },
  "Ø£Ø­Ù…Ø¯ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ": { main: "#3bb2f6", edited: "#22c55e" },
  "ÙŠØ­ÙŠÙ‰ Ø¹Ø³ÙŠØ±ÙŠ": { main: "#3bb2f6", edited: "#22c55e" },

  // PFM
  "Ø³Ù„Ø·Ø§Ù† Ø§Ù„Ø§Ø­Ù…Ø±ÙŠ": { main: "#8b5cf6", edited: "#22c55e" },
  "Ø£ÙŠÙ…Ù† Ø§Ù„Ø´Ù‡Ø±ÙŠ": { main: "#8b5cf6", edited: "#22c55e" },
  "ÙÙŠØµÙ„ Ø§Ù„ÙˆØ§Ø¯Ø¹ÙŠ": { main: "#8b5cf6", edited: "#22c55e" },

  // Ortho
  "ØªØ±ÙƒÙŠ Ø§Ù„Ø´Ù‡Ø±ÙŠ": { main: "#14b8a6", edited: "#22c55e" },
  "ÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ": { main: "#14b8a6", edited: "#22c55e" },
  "Ø£Ø³Ø§Ù…Ø© Ø¹Ø³ÙŠØ±ÙŠ": { main: "#14b8a6", edited: "#22c55e" },

  // Ù…ØªØ­Ø±Ùƒ
  "Ø±Ø´ÙŠØ¯ Ø§Ù„ÙƒØ«ÙŠØ±ÙŠ": { main: "#22c55e", edited: "#84cc16" },
  "Ø£Ø­Ù…Ø¯ Ø§Ù„ØµØ®Ø±ÙŠ": { main: "#22c55e", edited: "#84cc16" },
  "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ø·ÙŠÙ Ø¹Ø³ÙŠØ±ÙŠ": { main: "#22c55e", edited: "#84cc16" },
  "Ù…Ø­Ù…Ø¯ Ø§Ù„Ø´Ø±ÙØ§Ù†": { main: "#22c55e", edited: "#84cc16" },
  "Ø§Ù„Ø§Ø¡": { main: "#22c55e", edited: "#84cc16" },
  "Ù‡ÙŠØ§Ù…": { main: "#22c55e", edited: "#84cc16" },
  "Ù…Ø­Ù…Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ": { main: "#22c55e", edited: "#84cc16" },
  "Ù…Ù†ØµÙˆØ± Ø§Ù„Ø¹ÙˆÙŠØ±Ø¶ÙŠ": { main: "#22c55e", edited: "#84cc16" },
  "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ": { main: "#22c55e", edited: "#84cc16" },

  // Ù…Ø¤Ù‚Øª
  "Ø§Ø­Ù…Ø¯ Ø§Ù„Ø´Ø¨Ù„": { main: "#f59e0b", edited: "#22c55e" },
  "ÙˆÙ„ÙŠØ¯ Ø§Ù„Ø³ÙˆÙŠØ±ÙŠ": { main: "#f59e0b", edited: "#22c55e" },
  "ÙÙ‡Ø¯ Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ": { main: "#f59e0b", edited: "#22c55e" },
  "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹ÙˆØ¯": { main: "#f59e0b", edited: "#22c55e" },

  // Ø§Ù„ØµØ¨
  "ÙÙ‡Ø¯ Ø§Ù„Ø®Ù…ÙŠØ³": { main: "#b67b28", edited: "#22c55e" }
};

// Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª
const vacationList = ["ØªØ±ÙƒÙŠ Ø§Ù„Ø´Ù‡Ø±ÙŠ", "Ø³Ù„Ø·Ø§Ù† Ø§Ù„Ø§Ø­Ù…Ø±ÙŠ", "ÙŠØ­ÙŠÙ‰ Ø¹Ø³ÙŠØ±ÙŠ"];

async function loadCases() {
  const cases = await getCasesFromCloud();
  renderCases(cases);
  checkVacation(cases);
}

function renderCases(cases) {
  container.innerHTML = "";

  cases.forEach(c => {
    const isVacation = vacationList.includes(c.technicianName);

    const card = document.createElement("div");
    card.className = "tile";

    const colors = techColors[c.technicianName] || { main: "#0f766e", edited: "#22c55e" };
    card.style.borderRight = `8px solid ${colors.main}`;

    if (c.isEdited) {
      card.style.borderRight = `8px solid ${colors.edited}`;
    }

    card.innerHTML = `
      <h3>${c.patientName}</h3>
      <p>ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù: ${c.fileNumber}</p>
      <p>ğŸ‘¨â€ğŸ”§ Ø§Ù„ÙÙ†ÙŠ: ${c.technicianName}</p>
      <p style="font-size:11px;color:#64748b">${new Date(c.createdAt).toLocaleString()}</p>
      ${isVacation ? '<p style="color:red;font-weight:bold">âš  Ø§Ù„ÙÙ†ÙŠ Ø¥Ø¬Ø§Ø²Ø©</p>' : ""}
      <button onclick="editCase('${c.id}')" class="btn-logout" style="width:100%;margin-top:10px;background:#0f766e">ØªØ­Ø¯ÙŠØ¯ ÙƒÙ€ ØªØ¹Ø¯ÙŠÙ„</button>
    `;

    container.appendChild(card);
  });
}

window.editCase = async function(id) {
  await markCaseAsEdited(id);
  alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© âœ”");
  loadCases();
};

function checkVacation(cases) {
  const hasVacationCase = cases.some(c => vacationList.includes(c.technicianName));
  if (hasVacationCase) {
    vacationAlert.style.display = "block";
  }
}

loadCases();
</script>    
<script src="app.js"></script>

</body>
</html>

</body>
</html>
