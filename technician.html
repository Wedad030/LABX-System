<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>لوحة الفني - LABX</title>
    <link rel="stylesheet" href="style.css">
</head>

<body class="bg">
    <script>
// حماية النظام
if (localStorage.getItem("labxLogged") !== "true") {
    window.location.href = "login.html";
}
</script>
<div class="layout">

    <!-- هيدر الصفحة -->
    <header class="top-header">
        <div class="top-header-right">
            <img src="labx.jpeg" class="logo-img" alt="LABX Dental">
            <div class="brand-text">
                <div class="brand-title">LABX DENTAL</div>
                <div class="brand-sub">لوحة الفني</div>
            </div>
        </div>

        <div class="top-header-left">
            <button onclick="window.location.href='index.html'"
                    class="btn-logout" style="background:#0f766e;">
                رجوع
            </button>
        </div>
    </header>


    <!-- محتوى الصفحة -->
    <main class="main-card fade-in">

        <h2 style="margin-bottom:15px;">الحالات تحت الإجراء</h2>

        <div id="vacationAlert"
             style="padding:10px;background:#fed7aa;border-radius:10px;color:#b45309;display:none;">
            ⚠ يوجد فني في إجازة حالياً
        </div>

        <div id="casesContainer" class="tiles-grid"></div>

    </main>

</div>


<script>
// ---------------------------------------------------------
// جلب الفنيين + الإجازات من الإعدادات
// ---------------------------------------------------------
let techList = JSON.parse(localStorage.getItem("techList") || "[]");
let vacList = JSON.parse(localStorage.getItem("vacList") || "[]");

let cases = JSON.parse(localStorage.getItem("labxNewCases") || "[]");


// تحويل قائمة الفنيين إلى خريطة (اسم → لون)
const techColors = {};
techList.forEach(t => {
    techColors[t.name] = t.color;
});


// ---------------------------------------------------------
// عرض الحالات
// ---------------------------------------------------------
function renderCases() {
    const container = document.getElementById("casesContainer");
    container.innerHTML = "";

    const underProcess = cases.filter(c => c.status === "تحت الإجراء");

    underProcess.forEach(c => {

        // هل هذا الفني في إجازة؟
        let isVacation = vacList.includes(c.technicianName);

        const card = document.createElement("div");
        card.className = "tile";

        // إضافة اللون حسب الفني
        let color = techColors[c.technicianName] || "#0f766e";
        card.style.borderRight = `10px solid ${color}`;

        card.innerHTML = `
            <h3>${c.patientName}</h3>
            <p>رقم الملف: ${c.fileNumber}</p>
            <p>الفني: ${c.technicianName}</p>
            <p>نوع الحالة: ${c.caseType}</p>
            <p style="font-size:12px;color:#64748b;">وقت الدخول: ${c.createdAt}</p>

            ${isVacation ? `<p style="color:#ea580c;font-weight:bold;">⚠ الفني في إجازة</p>` : ""}

            <button onclick="markAsEdited(${c.id})"
                    class="btn-logout" style="background:#0f172a;margin-top:10px;width:100%;">
                تعديل الحالة
            </button>

            <button onclick="markAsReady(${c.id})"
                    class="btn-logout" style="background:#0f766e;margin-top:10px;width:100%;">
                جاهزة للتسليم ✔
            </button>
        `;

        container.appendChild(card);
    });
}


// ---------------------------------------------------------
// دالة تعديل الحالة
// ---------------------------------------------------------
function markAsEdited(id) {
    let index = cases.findIndex(c => c.id === id);
    if (index > -1) {
        cases[index].isEdited = true;
        localStorage.setItem("labxNewCases", JSON.stringify(cases));
        alert("✔ تم إرسال الحالة كتعديل");
        renderCases();
    }
}


// ---------------------------------------------------------
// دالة جاهزية الحالة
// ---------------------------------------------------------
function markAsReady(id) {
    let index = cases.findIndex(c => c.id === id);
    if (index > -1) {
        cases[index].status = "جاهزة";
        cases[index].readyTime = new Date().toLocaleString();

        localStorage.setItem("labxNewCases", JSON.stringify(cases));
        alert("✔ الحالة أصبحت جاهزة للتسليم");
        renderCases();
    }
}


// ---------------------------------------------------------
// تنبيه الإجازات
// ---------------------------------------------------------
function checkVacation() {
    if (vacList.length > 0) {
        document.getElementById("vacationAlert").style.display = "block";
    }
}


// تشغيل الصفحة
renderCases();
checkVacation();

</script>


</body>
</html>
