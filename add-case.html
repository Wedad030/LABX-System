<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>إضافة حالة - LABX Dental</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            padding: 20px;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 650px;
            margin: 0 auto;
        }
        h2 {
            margin-top: 0;
            font-weight: bold;
        }
        label {
            display: block;
            margin-top: 10px;
            font-size: 15px;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px 10px;
            margin-top: 5px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 14px;
            margin-top: 20px;
            background: #0b6623;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 17px;
            cursor: pointer;
        }
        button:hover {
            opacity: 0.9;
        }
        #rejectAlert {
            display: none;
            background: #fff0f0;
            color: #b00000;
            padding: 10px 15px;
            border-radius: 6px;
            border-right: 5px solid #b00000;
            margin-top: 12px;
            font-size: 13px;
            font-weight: bold;
        }
        #resultCard {
            display: none;
            margin-top: 25px;
            padding: 20px;
            border-radius: 10px;
            background: #ffffff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            text-align: center;
        }
        #resultCard h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        #resultText {
            font-size: 14px;
            line-height: 1.7;
            margin-bottom: 15px;
        }
        .qr-box {
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>إضافة حالة جديدة</h2>

    <label>اسم المريض:</label>
    <input id="patientName" type="text" />

    <label>رقم الملف:</label>
    <input id="fileNumber" type="number" />

    <label>اسم الطبيب:</label>
    <input id="doctor" type="text" />

    <label>اسم المساعدة:</label>
    <input id="assistant" type="text" />

    <label>رقم العيادة:</label>
    <input id="clinic" type="number" />

    <label>نوع الحالة:</label>
    <select id="caseType">
        <option value="">اختر نوع الحالة</option>
        <option value="new">حالة جديدة</option>
        <option value="adjust">تعديل / إعادة</option>
        <option value="RPD 3 teeth or less">RPD 3 teeth or less</option>
        <option value="TM 3 teeth or less">TM 3 teeth or less</option>
        <option value="RPD ثلاث اسنان او اقل">RPD ثلاث اسنان او اقل</option>
        <option value="TM ثلاث اسنان او اقل">TM ثلاث اسنان او اقل</option>
    </select>

    <label>القسم:</label>
    <select id="department">
        <option value="">اختر القسم</option>
        <option value="cad">قسم الكاد كام</option>
        <option value="pfm">قسم PFM</option>
        <option value="ortho">قسم الأوثو</option>
        <option value="removable">قسم المتحرك</option>
        <option value="temp">قسم المؤقت</option>
        <option value="casting">قسم الكاستنغ / الصب</option>
    </select>

    <label>الفني المسؤول:</label>
    <select id="technician">
        <option value="">اختر الفني</option>
    </select>

    <div id="rejectAlert">⚠️ هذه حالة مرفوضة من قبل المعمل ولا يمكن قبولها.</div>

    <label>ملاحظات:</label>
    <textarea id="notes" rows="3"></textarea>

    <button onclick="saveCase()">حفظ الحالة</button>
</div>

<div id="resultCard">
    <h3>تم حفظ الحالة بنجاح ✅</h3>
    <p id="resultText"></p>
    <div class="qr-box">
        <canvas id="qrcode"></canvas>
    </div>
</div>

<!-- مكتبة QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<script>
/* ===============================
   قائمة الفنيين لكل قسم + الإجازات
   =============================== */
const technicians = {
    cad: [
        { name: "قاسم عسيري", off: false },
        { name: "أحمد كوشان", off: false },
        { name: "عبدالله الرشيد", off: false },
        { name: "عبدالله الشهراني", off: false },
        { name: "أحمد القحطاني", off: false },
        { name: "يحيى عسيري", off: true }   // إجازة
    ],
    pfm: [
        { name: "سلطان الأحمري", off: true }, // إجازة
        { name: "أيمن الشهري", off: false },
        { name: "فيصل الوادعي", off: false }
    ],
    ortho: [
        { name: "تركي الشهري", off: true },   // إجازة
        { name: "وليد الشهري", off: false },
        { name: "أسامة عسيري", off: false }
    ],
    removable: [
        { name: "رشيد الكثيري", off: false },
        { name: "أحمد الصخري", off: false },
        { name: "عبداللطيف عسيري", off: false },
        { name: "محمد الشرفان", off: false },
        { name: "الاء", off: false },
        { name: "هيام", off: false },
        { name: "محمد الغامدي", off: false },
        { name: "منصور العويرضي", off: false },
        { name: "عبدالله الغامدي", off: false }
    ],
    temp: [
        { name: "أحمد الشبل", off: false },
        { name: "وليد السويري", off: false },
        { name: "فهد العتيبي", off: false },
        { name: "عبدالله العود", off: false }
    ],
    casting: [
        { name: "فهد الخميس", off: false }
    ]
};

// الحقول
const caseTypeSelect   = document.getElementById("caseType");
const deptSelect       = document.getElementById("department");
const techSelect       = document.getElementById("technician");
const rejectAlert      = document.getElementById("rejectAlert");
const resultCard       = document.getElementById("resultCard");
const resultText       = document.getElementById("resultText");

// أنواع الحالات المرفوضة
const rejectedCasesList = [
    "RPD 3 teeth or less",
    "TM 3 teeth or less",
    "RPD ثلاث اسنان او اقل",
    "TM ثلاث اسنان او اقل"
];

/* ===================
   تنبيه الحالات المرفوضة
   =================== */
caseTypeSelect.addEventListener("change", function () {
    const type = this.value.trim();
    rejectAlert.style.display = rejectedCasesList.includes(type) ? "block" : "none";
});

/* ===================
   تعبئة الفنيين حسب القسم
   =================== */
deptSelect.addEventListener("change", function () {
    const dep = this.value;
    techSelect.innerHTML = '<option value="">اختر الفني</option>';

    const list = technicians[dep];
    if (!list) return;

    list.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.name;
        opt.textContent = t.off ? `${t.name} (إجازة)` : t.name;
        if (t.off) opt.style.color = "orange";
        techSelect.appendChild(opt);
    });
});

/* ===================
   حفظ الحالة + إنشاء QR
   =================== */
function saveCase() {
    const name  = document.getElementById("patientName").value.trim();
    const file  = document.getElementById("fileNumber").value.trim();
    const doctor= document.getElementById("doctor").value.trim();
    const assist= document.getElementById("assistant").value.trim();
    const clinic= document.getElementById("clinic").value.trim();
    const type  = caseTypeSelect.value.trim();
    const dep   = deptSelect.value.trim();
    const tech  = techSelect.value.trim();
    const notes = document.getElementById("notes").value.trim();

    // تحقق بسيط
    if (!name || !file || !doctor || !assist || !clinic || !type || !dep || !tech) {
        alert("فضلاً عبّي جميع الحقول الأساسية قبل الحفظ.");
        return;
    }

    // إيقاف الحفظ إذا الحالة مرفوضة
    if (rejectedCasesList.includes(type)) {
        alert("❌ هذه حالة مرفوضة من قبل المعمل ولا يمكن تسجيلها.");
        return;
    }

    // رقم توزيع عشوائي من 6 أرقام
    const caseNumber = Math.floor(100000 + Math.random() * 900000);
    const now        = new Date();
    const time       = now.toLocaleTimeString("en-US");
    const date       = now.toLocaleDateString("en-US");

    // نص النتيجة
    resultText.innerHTML =
        `اسم المريض: ${name}<br>
         رقم الملف: ${file}<br>
         رقم التوزيع: ${caseNumber}<br>
         القسم: ${dep}<br>
         الفني المسؤول: ${tech}<br>
         التاريخ والوقت: ${date} / ${time}<br>
         ملاحظات: ${notes || "لا يوجد"}`;

    // إنشاء رابط تفاصيل الحالة (لاحقاً ممكن نربطه بصفحة التفاصيل)
    const qrLink = `https://wedad030.github.io/LABX-System/case-details.html?id=${caseNumber}`;

    // مسح أي QR قديم
    const qrCanvas = document.getElementById("qrcode");
    const context = qrCanvas.getContext && qrCanvas.getContext("2d");
    if (context) {
        context.clearRect(0, 0, qrCanvas.width, qrCanvas.height);
    }

    // إنشاء QR جديد
    new QRious({
        element: qrCanvas,
        value: qrLink,
        size: 200
    });

    // إظهار الكرت
    resultCard.style.display = "block";
}
</script>
</body>
</html>
