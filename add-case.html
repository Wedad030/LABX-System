<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ุฅุถุงูุฉ ุญุงูุฉ - LABX</title>
  <link rel="stylesheet" href="style.css" />

  <!-- ููุชุจุฉ QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    /* ุจุนุถ ุงูููุณุงุช ุงูุฎุงุตุฉ ุจูุฐู ุงูุตูุญุฉ ููุท */

    .form-card {
      max-width: 900px;
      margin: 25px auto;
      background: var(--card-bg, #fff);
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      padding: 24px 26px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 14px 18px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 14px;
    }

    .form-group label {
      font-weight: 600;
      color: #444;
    }

    .form-group small {
      color: #777;
      font-size: 11px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      border-radius: 10px;
      border: 1px solid #d3d7dd;
      padding: 8px 10px;
      font-size: 14px;
    }

    .form-group textarea {
      min-height: 70px;
      resize: vertical;
    }

    .section-title {
      font-weight: 700;
      margin: 18px 0 8px;
      font-size: 15px;
      color: var(--green-main, #0f766e);
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .chip {
      padding: 4px 10px;
      border-radius: 999px;
      background: #f2f4f7;
      font-size: 11px;
    }

    .chip-orange {
      background: #ffedd5;
      color: #b45309;
      font-weight: 600;
    }

    .chip-red {
      background: #fee2e2;
      color: #b91c1c;
      font-weight: 600;
    }

    .warning-box {
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #fef2f2;
      border: 1px solid #fecaca;
      font-size: 13px;
      color: #b91c1c;
      display: none;
    }

    .motivation {
      margin-top: 12px;
      font-size: 13px;
      color: #4b5563;
      text-align: center;
    }

    .motivation span {
      color: var(--green-main, #0f766e);
      font-weight: 700;
    }

    .actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 18px;
      justify-content: space-between;
      align-items: center;
    }

    .btn-main {
      background: var(--green-main, #0f766e);
      color: #fff;
      border-radius: 999px;
      padding: 10px 24px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn-main:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.14);
    }

    .btn-ghost {
      background: #f3f4f6;
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
    }

    .qr-preview {
      margin-top: 10px;
      text-align: center;
    }

    .qr-preview canvas {
      margin: 0 auto;
    }

    @media (max-width: 720px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body class="bg">
  <div class="layout fade-in">

    <!-- ุงูููุฏุฑ -->
    <header class="top-header slide-down">
      <div class="top-header-right">
        <img src="labx.jpeg" class="logo-img" alt="LABX Dental" />
        <div class="brand-text">
          <div class="brand-title">LABX DENTAL</div>
          <div class="brand-sub">Add Case</div>
        </div>
      </div>

      <div class="top-header-left">
        <div class="user-info">
          <span class="hello-text">ูุฑุญุจุงูุ</span>
          <span id="username" class="user-name">User</span>
        </div>
      </div>
    </header>

    <!-- ุงููุญุชูู -->
    <main class="main-card fade-in">
      <div class="form-card slide-up">
        <h2 style="margin-bottom: 10px;">ุฅุถุงูุฉ ุญุงูุฉ ุฌุฏูุฏุฉ</h2>
        <p style="font-size:13px;color:#6b7280;margin-bottom:18px;">
          ูุฑุฌู ุชุนุจุฆุฉ ุจูุงูุงุช ุงูุญุงูุฉ ุจุฏูุฉุ ุงููุธุงู ุฑุงุญ ููุฒุน ุงูุญุงูุฉ ุชููุงุฆูุงู ุนูู ุงูููู ุงูููุงุณุจ ููููุฏ QR ููู ุญุงูุฉ.
        </p>

        <!-- ูููุฐุฌ ุจูุงูุงุช ุงูุญุงูุฉ -->
        <form id="addCaseForm">
          <div class="form-grid">
            <!-- ุจูุงูุงุช ุฃุณุงุณูุฉ -->
            <div class="form-group">
              <label for="patientName">ุงุณู ุงููุฑูุถ</label>
              <input id="patientName" type="text" required placeholder="Patient Name" />
            </div>

            <div class="form-group">
              <label for="fileNumber">ุฑูู ุงูููู</label>
              <input id="fileNumber" type="text" required placeholder="File Number" />
            </div>

            <div class="form-group">
              <label for="doctorName">ุงุณู ุงูุทุจูุจ</label>
              <input id="doctorName" type="text" required placeholder="Doctor Name" />
            </div>

            <div class="form-group">
              <label for="assistantName">ุงุณู ุงููุณุงุนุฏุฉ</label>
              <input id="assistantName" type="text" placeholder="Assistant Name" />
            </div>

            <div class="form-group">
              <label for="clinicNumber">ุฑูู ุงูุนูุงุฏุฉ</label>
              <input id="clinicNumber" type="text" placeholder="Clinic No." />
            </div>

            <!-- ููุน ุงูุญุงูุฉ ุงูุฑุฆูุณู -->
            <div class="form-group">
              <label for="caseMainType">ููุน ุงูุญุงูุฉ</label>
              <select id="caseMainType" required>
                <option value="">โ ุงุฎุชุงุฑู โ</option>
                <option value="new">ุญุงูุฉ ุฌุฏูุฏุฉ</option>
                <option value="remake">ุฅุนุงุฏุฉ</option>
                <option value="adjustment">ุชุนุฏูู</option>
                <option value="second-step">ุฎุทูุฉ ุซุงููุฉ</option>
              </select>
              <small>ูุณุชุฎุฏู ูู ุงููุฑุฒ ุงูุฅุญุตุงุฆู.</small>
            </div>

            <!-- ุงููุณู -->
            <div class="form-group">
              <label for="department">ุงููุณู</label>
              <select id="department" required>
                <option value="">โ ุงุฎุชุงุฑู ุงููุณู โ</option>
                <option value="cadcam">ูุณู ุงููุงุฏ ูุงู</option>
                <option value="pfm">ูุณู PFM</option>
                <option value="ortho">ูุณู ุงูุฃูุซู</option>
                <option value="removable">ูุณู ุงููุชุญุฑู</option>
                <option value="temp">ูุณู ุงููุคูุช</option>
                <option value="casting">ูุณู ุงูุตุจ</option>
              </select>
              <small>ุจุนุฏ ุงุฎุชูุงุฑ ุงููุณู ุชุธูุฑ ูุงุฆูุฉ ุงูููููู ุชููุงุฆูุงู.</small>
            </div>

            <!-- ุงูููู -->
            <div class="form-group">
              <label for="technician">ุงูููู ุงููุณุคูู</label>
              <select id="technician" required>
                <option value="">โ ุงุฎุชุงุฑู ุฃููุงู ุงููุณู โ</option>
              </select>
              <small id="vacationHint" style="color:#b45309;display:none;">
                โ ุงูููู ุงููุญุฏุฏ ุญุงููุงู ูู ุฅุฌุงุฒุฉุ ููุถู ุงุฎุชูุงุฑ ููู ุขุฎุฑ.
              </small>
            </div>

            <!-- ููุน ุญุงูุฉ ูุฑููุถุฉ -->
            <div class="form-group">
              <label for="rejectType">ูู ุงูุญุงูุฉ ูุฑููุถุฉ ูู ุงููุนููุ</label>
              <select id="rejectType">
                <option value="">ูุงุ ุญุงูุฉ ุนุงุฏูุฉ</option>
                <option value="rpd-3">RPD โ ุซูุงุซ ุฃุณูุงู ุฃู ุฃูู</option>
                <option value="temp-3">Temp Crown โ ุซูุงุซ ุฃุณูุงู ุฃู ุฃูู</option>
              </select>
              <small>ูู ุญุงู ุงุฎุชูุงุฑ ููุน ูุฑููุถุ ุณูุธูุฑ ุชูุจูู ุจุงูููู ุงูุฃุญูุฑ.</small>
            </div>

            <!-- ุชุงุฑูุฎ ูููุช -->
            <div class="form-group">
              <label>ุชุงุฑูุฎ ุงูุชุณุฌูู (ุจุงูุฅูุฌููุฒู)</label>
              <input id="createdDate" type="text" readonly />
            </div>

            <div class="form-group">
              <label>ููุช ุงูุชุณุฌูู (ุจุงูุฅูุฌููุฒู)</label>
              <input id="createdTime" type="text" readonly />
            </div>

            <!-- ุฑูุน ููู -->
            <div class="form-group">
              <label for="caseFile">ุฑูุน ุตูุฑุฉ ุฃู ููู</label>
              <input id="caseFile" type="file" accept="image/*,.pdf" />
              <small>ุญุงูููุง ูุชู ุญูุธ ุงุณู ุงูููู ููุท. ูุงุญููุง ูุฑุจุทูุง ุจุชุฎุฒูู ุณุญุงุจู.</small>
            </div>

            <!-- ุฑูู ุชูุฒูุน ุขูู -->
            <div class="form-group">
              <label>ุฑูู ุชูุฒูุน ุงูุญุงูุฉ</label>
              <input id="caseNumber" type="text" readonly />
              <small>ูุชู ุชูููุฏู ุชููุงุฆููุง ุนูุฏ ูุชุญ ุงูุตูุญุฉ.</small>
            </div>

            <!-- ููุงุญุธุงุช -->
            <div class="form-group" style="grid-column:1 / -1;">
              <label for="notes">ููุงุญุธุงุช</label>
              <textarea id="notes" placeholder="ุฃู ููุงุญุธุงุช ุฅุถุงููุฉ ุนูู ุงูุญุงูุฉ"></textarea>
            </div>
          </div>

          <!-- ุชูุจููุงุช ุฎุงุตุฉ ุจุงูุฑูุถ -->
          <div id="rejectWarning" class="warning-box">
            โ ุชูุจูู: ูุฐู ุงูุญุงูุฉ ุถูู ุงูุญุงูุงุช <span id="rejectLabel"></span> (3 ุฃุณูุงู ุฃู ุฃูู)ุ
            ุงูุฑุฌุงุก ุงูุชุฃูุฏ ูู ุชุนุจุฆุฉ ุฌููุน ุงูุจูุงูุงุช ูููุงูุดุฉ ุงูุฏูุชูุฑ ูุจู ุงูุฅุฑุณุงู.
          </div>

          <!-- ุนุฑุถ ุงูููููู ูู ุงูุฅุฌุงุฒุฉ -->
          <div class="section-title">ุงูููููู ูู ุฅุฌุงุฒุฉ ุงูููู</div>
          <div class="chips-row" id="vacationChips"></div>

          <!-- QR PREVIEW -->
          <div class="section-title">QR ููุญุงูุฉ</div>
          <p style="font-size:12px;color:#6b7280;">
            ูุชู ุชูููุฏ QR ุชููุงุฆููุง ูุญุชูู: ุงุณู ุงููุฑูุถุ ุฑูู ุงููููุ ุฑูู ุงูุญุงูุฉุ ุงููุณูุ ุงููููุ ูุชุงุฑูุฎ ุงูุชุณุฌูู.
          </p>
          <div class="qr-preview">
            <div id="qrcode"></div>
          </div>

          <!-- ุฃุฒุฑุงุฑ -->
          <div class="actions-row">
            <div>
              <button type="submit" class="btn-main">ุญูุธ ุงูุญุงูุฉ</button>
            </div>
            <div style="display:flex;gap:6px;">
              <button type="button" class="btn-ghost" onclick="window.location.href='index.html'">
                โฌ ุฑุฌูุน ููุตูุญุฉ ุงูุฑุฆูุณูุฉ
              </button>
              <button type="button" class="btn-ghost" onclick="window.location.href='ready-cases.html'">
                ๐ ุจุญุซ ูู ุงูุญุงูุงุช
              </button>
            </div>
          </div>

          <div class="motivation">
            ูู ุญุงูุฉ ุชูุซููููุง ุงูููู ุชูุฑุจู ูู <span>ูุธุงู ูุนูู ููุธู ููุฏูุก ุฐููู ูู</span> ๐ค
          </div>
        </form>
      </div>
    </main>
  </div>

  <!-- ุณูุฑุจุชุงุช ุงููุธุงู -->
  <script src="app.js"></script>

  <!-- ุฑุจุท Firebase + ููุทู ุงูุตูุญุฉ -->
  <script type="module">
    import { saveCaseToCloud } from "./firebase.js";

    // ------------- ุจูุงูุงุช ุงูููููู ุญุณุจ ุงููุณู -------------
    const techniciansByDept = {
      cadcam: [
        "ูุงุณู ุนุณูุฑู",
        "ุฃุญูุฏ ููุดุงู",
        "ุนุจุฏุงููู ุงูุฑุดูุฏ",
        "ุนุจุฏุงููู ุงูุดูุฑุงูู",
        "ุฃุญูุฏ ุงููุญุทุงูู",
        "ูุญูู ุนุณูุฑู",
      ],
      pfm: [
        "ุณูุทุงู ุงูุงุญูุฑู",
        "ุฃููู ุงูุดูุฑู",
        "ููุตู ุงููุงุฏุนู",
      ],
      ortho: [
        "ุชุฑูู ุงูุดูุฑู",
        "ูููุฏ ุงูุดูุฑู",
        "ุฃุณุงูุฉ ุนุณูุฑู",
      ],
      removable: [
        "ุฑุดูุฏ ุงููุซูุฑู",
        "ุฃุญูุฏ ุงูุตุฎุฑู",
        "ุนุจุฏุงููุทูู ุนุณูุฑู",
        "ูุญูุฏ ุงูุดุฑูุงู",
        "ุงูุงุก",
        "ููุงู",
        "ูุญูุฏ ุงูุบุงูุฏู",
        "ููุตูุฑ ุงูุนููุฑุถู",
        "ุนุจุฏุงููู ุงูุบุงูุฏู",
      ],
      temp: [
        "ุงุญูุฏ ุงูุดุจู",
        "ูููุฏ ุงูุณููุฑู",
        "ููุฏ ุงูุนุชูุจู",
        "ุนุจุฏุงููู ุงูุนูุฏ",
      ],
      casting: [
        "ููุฏ ุงูุฎููุณ",
      ],
    };

    // ุงูููููู ูู ุฅุฌุงุฒุฉ
    const vacationTechs = ["ุชุฑูู ุงูุดูุฑู", "ุณูุทุงู ุงูุงุญูุฑู", "ูุญูู ุนุณูุฑู"];

    // ุนูุงุตุฑ ุงูุตูุญุฉ
    const departmentSelect   = document.getElementById("department");
    const technicianSelect   = document.getElementById("technician");
    const vacationHint       = document.getElementById("vacationHint");
    const rejectTypeSelect   = document.getElementById("rejectType");
    const rejectWarning      = document.getElementById("rejectWarning");
    const rejectLabel        = document.getElementById("rejectLabel");
    const vacationChips      = document.getElementById("vacationChips");
    const form               = document.getElementById("addCaseForm");

    const createdDateInput   = document.getElementById("createdDate");
    const createdTimeInput   = document.getElementById("createdTime");
    const caseNumberInput    = document.getElementById("caseNumber");
    const patientNameInput   = document.getElementById("patientName");
    const fileNumberInput    = document.getElementById("fileNumber");
    const doctorNameInput    = document.getElementById("doctorName");
    const assistantNameInput = document.getElementById("assistantName");
    const clinicNumberInput  = document.getElementById("clinicNumber");
    const caseMainTypeInput  = document.getElementById("caseMainType");
    const notesInput         = document.getElementById("notes");
    const caseFileInput      = document.getElementById("caseFile");

    // -------- ุถุจุท ุงูุชุงุฑูุฎ ูุงูููุช ูุฑูู ุงูุญุงูุฉ ุนูุฏ ูุชุญ ุงูุตูุญุฉ --------
    function initMeta() {
      const now = new Date();
      createdDateInput.value = now.toLocaleDateString("en-GB");  // DD/MM/YYYY
      createdTimeInput.value = now.toLocaleTimeString("en-GB");  // HH:MM:SS
      caseNumberInput.value  = "LABX-" + now.getTime();          // ุฑูู ุชูุฒูุน
    }

    // -------- ุฅูุดุงุก ุดุงุฑุงุช ุงูููููู ูู ุงูุฅุฌุงุฒุฉ --------
    function renderVacationChips() {
      vacationChips.innerHTML = "";
      vacationTechs.forEach(name => {
        const span = document.createElement("span");
        span.className = "chip chip-orange";
        span.textContent = name;
        vacationChips.appendChild(span);
      });
    }

    // -------- ุชุญููู ุงูููููู ุญุณุจ ุงููุณู --------
    function loadTechniciansForDept() {
      const dept = departmentSelect.value;
      technicianSelect.innerHTML = "";

      if (!dept || !techniciansByDept[dept]) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "โ ุงุฎุชุงุฑู ุฃููุงู ุงููุณู โ";
        technicianSelect.appendChild(opt);
        return;
      }

      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "โ ุงุฎุชุงุฑู ุงูููู โ";
      technicianSelect.appendChild(placeholder);

      techniciansByDept[dept].forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;

        if (vacationTechs.includes(name)) {
          opt.textContent += " (ุฅุฌุงุฒุฉ)";
          opt.style.color = "#b45309";
        }

        technicianSelect.appendChild(opt);
      });
    }

    // -------- ูุฑุงูุจุฉ ุงุฎุชูุงุฑ ููู ูู ุฅุฌุงุฒุฉ --------
    function handleTechnicianChange() {
      const tech = technicianSelect.value;
      if (vacationTechs.includes(tech)) {
        vacationHint.style.display = "block";
      } else {
        vacationHint.style.display = "none";
      }
      generateQRPreview(); // ูุญุฏุซ ุงูู QR ุนูุฏ ุชุบููุฑ ุงูููู
    }

    // -------- ุชูุจูู ุญุงูุงุช ุงูุฑูุถ --------
    function handleRejectChange() {
      const val = rejectTypeSelect.value;
      if (!val) {
        rejectWarning.style.display = "none";
        rejectLabel.textContent = "";
        return;
      }

      if (val === "rpd-3") {
        rejectLabel.textContent = "RPD (ูฃ ุฃุณูุงู ุฃู ุฃูู)";
      } else if (val === "temp-3") {
        rejectLabel.textContent = "Temporary Crown (ูฃ ุฃุณูุงู ุฃู ุฃูู)";
      }
      rejectWarning.style.display = "block";
    }

    // -------- ุชูููุฏ ูุต ุงูู QR --------
    function buildQRText() {
      const dept = departmentSelect.options[departmentSelect.selectedIndex]?.text || "";
      const tech = technicianSelect.value || "";
      return `
LABX Dental
Case No: ${caseNumberInput.value}
Patient: ${patientNameInput.value}
File: ${fileNumberInput.value}
Doctor: ${doctorNameInput.value}
Dept: ${dept}
Tech: ${tech}
Created: ${createdDateInput.value} ${createdTimeInput.value}
`.trim();
    }

    // -------- ุชูููุฏ QR ูุนุฑุถู --------
    let qrInstance = null;
    function generateQRPreview() {
      const qrContainer = document.getElementById("qrcode");
      qrContainer.innerHTML = "";
      const text = buildQRText();
      if (!text) return;
      qrInstance = new QRCode(qrContainer, {
        text,
        width: 132,
        height: 132,
      });
    }

    // -------- ุนูุฏ ุฅุฑุณุงู ุงููููุฐุฌ --------
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!patientNameInput.value || !fileNumberInput.value || !doctorNameInput.value) {
        alert("ุฑุฌุงุกู ุชุฃูุฏู ูู ุชุนุจุฆุฉ: ุงุณู ุงููุฑูุถุ ุฑูู ุงููููุ ุงุณู ุงูุทุจูุจ.");
        return;
      }

      if (!departmentSelect.value || !technicianSelect.value) {
        alert("ุฑุฌุงุกู ุงุฎุชุงุฑู ุงููุณู ูุงูููู.");
        return;
      }

      const file = caseFileInput.files[0];
      const fileInfo = file
        ? { name: file.name, type: file.type, size: file.size }
        : null;

      const caseData = {
        caseNumber:   caseNumberInput.value,
        patientName:  patientNameInput.value,
        fileNumber:   fileNumberInput.value,
        doctorName:   doctorNameInput.value,
        assistantName:assistantNameInput.value,
        clinicNumber: clinicNumberInput.value,
        caseMainType: caseMainTypeInput.value,
        department:   departmentSelect.value,
        technicianName: technicianSelect.value,
        notes:        notesInput.value,
        rejectType:   rejectTypeSelect.value,
        createdDate:  createdDateInput.value,
        createdTime:  createdTimeInput.value,
        createdAtISO: new Date().toISOString(),
        status:       rejectTypeSelect.value ? "ูุฑููุถุฉ" : "ุชุญุช ุงูุฅุฌุฑุงุก",
        fileInfo,
      };

      // ุญูุธ ูุณุฎุฉ ูุญููุฉ ุงุญุชูุงุทูุฉ
      const local = JSON.parse(localStorage.getItem("labxNewCases") || "[]");
      local.push(caseData);
      localStorage.setItem("labxNewCases", JSON.stringify(local));

      // ุญูุธ ูู Firebase
      try {
        await saveCaseToCloud(caseData);
      } catch (err) {
        console.error(err);
        alert("ุชู ุญูุธ ุงูุญุงูุฉ ูุญูููุงุ ููู ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุณุญุงุจุฉ.");
      }

      alert("โ ุชู ุญูุธ ุงูุญุงูุฉ ูุชูููุฏ ุฑูู ุชูุฒูุน ู QR ุจูุฌุงุญ.");
      window.location.href = "index.html";
    });

    // -------- ุฑุจุท ุงูุฃุญุฏุงุซ --------
    departmentSelect.addEventListener("change", () => {
      loadTechniciansForDept();
      generateQRPreview();
    });

    technicianSelect.addEventListener("change", handleTechnicianChange);
    rejectTypeSelect.addEventListener("change", handleRejectChange);

    [
      patientNameInput,
      fileNumberInput,
      doctorNameInput,
      createdDateInput,
      createdTimeInput,
    ].forEach(el => el.addEventListener("input", generateQRPreview));

    // -------- ุชููุฆุฉ ุงูุตูุญุฉ ุนูุฏ ุงูุชุญููู --------
    initMeta();
    renderVacationChips();
    generateQRPreview();
  </script>
</body>
</html>
