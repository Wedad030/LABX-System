<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>إضافة حالة - LABX</title>
    <link rel="stylesheet" href="style.css">
</head>

<body class="bg">

<script>
// حماية النظام
if (localStorage.getItem("labxLogged") !== "true") {
    window.location.href = "login.html";
}
</script>

<div class="layout">

    <!-- الهيدر -->
    <header class="top-header">
        <div class="top-header-right">
            <img src="labx.jpeg" class="logo-img" alt="LABX Dental">
            <div class="brand-text">
                <div class="brand-title">LABX DENTAL</div>
                <div class="brand-sub">Add Case</div>
            </div>
        </div>

        <div class="top-header-left">
            <button onclick="window.location.href='index.html'" 
                    class="btn-logout" style="background:#0f766e;">
                رجوع
            </button>
        </div>
    </header>


    <!-- الصفحة -->
    <main class="main-card fade-in">

        <h2 style="text-align:center;margin-bottom:20px;">إضافة حالة جديدة</h2>

        <label>اسم المريض:</label>
        <input id="patientName" class="input" placeholder="اسم المريض">

        <label>رقم الملف:</label>
        <input id="fileNumber" class="input" placeholder="رقم الملف">

        <label>اسم الطبيب:</label>
        <input id="doctorName" class="input" placeholder="اسم الطبيب">

        <label>اسم المساعدة:</label>
        <input id="assistantName" class="input" placeholder="اسم المساعدة">

        <label>رقم العيادة:</label>
        <input id="clinicNumber" class="input" placeholder="رقم العيادة">

        <label>نوع الحالة:</label>
        <select id="caseType" class="input"></select>

        <label>الفني المسؤول:</label>
        <select id="technician" class="input"></select>

        <label>ملاحظات:</label>
        <textarea id="notes" class="input" rows="3"></textarea>

        <button onclick="saveCase()" class="btn-logout" 
                style="background:#0f766e;margin-top:15px;width:100%;">
            حفظ الحالة
        </button>

    </main>

</div>


<!-- سكربت الصفحة -->
<script>

// ---------------------------------------------------------
// تحميل الفنيين + الأقسام من إعدادات settings.html
// ---------------------------------------------------------
let techList = JSON.parse(localStorage.getItem("techList") || "[]");
let deptList = JSON.parse(localStorage.getItem("deptList") || "[]");

function loadDynamicLists() {
    const techSelect = document.getElementById("technician");
    const caseTypeSelect = document.getElementById("caseType");

    techSelect.innerHTML = "";
    caseTypeSelect.innerHTML = "";

    // الأقسام
    deptList.forEach(d => {
        let opt = document.createElement("option");
        opt.value = d;
        opt.innerText = d;
        caseTypeSelect.appendChild(opt);
    });

    // الفنيين
    techList.forEach(t => {
        let opt = document.createElement("option");
        opt.value = t.name;
        opt.innerText = t.name;
        techSelect.appendChild(opt);
    });
}

window.onload = loadDynamicLists;


// ---------------------------------------------------------
// حفظ الحالة + ربطها بصفحة الفني + QR Code
// ---------------------------------------------------------
function saveCase() {
    let patientName = document.getElementById("patientName").value.trim();
    let fileNumber = document.getElementById("fileNumber").value.trim();
    let doctorName = document.getElementById("doctorName").value.trim();
    let assistantName = document.getElementById("assistantName").value.trim();
    let clinicNumber = document.getElementById("clinicNumber").value.trim();
    let caseType = document.getElementById("caseType").value.trim();
    let technician = document.getElementById("technician").value.trim();
    let notes = document.getElementById("notes").value.trim();

    if (!patientName || !fileNumber || !doctorName || !assistantName || !caseType || !technician) {
        alert("⚠️ يرجى تعبئة جميع البيانات الأساسية.");
        return;
    }

    let cases = JSON.parse(localStorage.getItem("labxNewCases") || "[]");

    // إنشاء QR خاص بالحالة
    let qrValue = `LABX-${fileNumber}-${Date.now()}`;

    let newCase = {
        id: Date.now(),
        patientName,
        fileNumber,
        doctorName,
        assistantName,
        clinicNumber,
        caseType,
        technicianName: technician,
        notes,
        createdAt: new Date().toLocaleString(),
        status: "تحت الإجراء",
        qrValue
    };

   import { saveCaseToCloud } from "./firebase.js";

document.getElementById("caseForm").addEventListener("submit", async function(e){
  e.preventDefault();

  const patientName = document.getElementById("patientName").value;
  const fileNumber = document.getElementById("fileNumber").value;
  const doctorName = document.getElementById("doctorName").value;
  const assistantName = document.getElementById("assistantName").value;
  const clinicNumber = document.getElementById("clinicNumber").value;
  const caseType = document.getElementById("caseType").value;
  const technicianName = document.getElementById("technicianName").value;
  const notes = document.getElementById("notes").value;

  const qrValue = `${patientName}-${fileNumber}-${Date.now()}`;

  const newCase = {
    patientName,
    fileNumber,
    doctorName,
    assistantName,
    clinicNumber,
    caseType,
    technicianName,
    notes,
    createdAt: new Date().toISOString(),
    status: "تحت الإجراء",
    qrValue
  };

  try {
    await saveCaseToCloud(newCase);
    alert("✨ تم حفظ الحالة بنجاح في Firebase");
    window.location.href = "index.html";
  } catch (err) {
    alert("❌ حدث خطأ أثناء الحفظ");
    console.error(err);
  }
});

</script>

<!-- ... باقي الصفحة ... -->

<script type="module" src="firebase.js"></script>
    <script type="module">
import { saveCaseToCloud } from "./firebase.js";

document.getElementById("caseForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    // قراءة البيانات من الفورم
    const patientName = document.getElementById("patientName").value;
    const fileNumber = document.getElementById("fileNumber").value;
    const doctorName = document.getElementById("doctorName").value;
    const assistantName = document.getElementById("assistantName").value;
    const clinicNumber = document.getElementById("clinicNumber").value;
    const caseType = document.getElementById("caseType").value;
    const technicianName = document.getElementById("technicianName").value;
    const notes = document.getElementById("notes").value;

    // إنشاء QR بسيط
    const qrValue = `${fileNumber}-${Date.now()}`;

    // تجهيز الحالة
    const newCase = {
        patientName,
        fileNumber,
        doctorName,
        assistantName,
        clinicNumber,
        caseType,
        technicianName,
        notes,
        qrValue,
        status: "تحت الإجراء",
        createdAt: new Date().toISOString()
    };

    try {
        await saveCaseToCloud(newCase);
        alert("✅ تم حفظ الحالة في النظام السحابي بنجاح");
        window.location.href = "index.html";
    } catch (err) {
        alert("❌ حدث خطأ أثناء حفظ الحالة");
        console.error(err);
    }
});
</script>
<script src="app.js"></script>

</body>
</html>
</body>
</html>
