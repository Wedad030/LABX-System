<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>استلام العيادة - LABX</title>
    <link rel="stylesheet" href="style.css">

    <!-- مكتبة QR Reader -->
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        .scan-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px #00000015;
            margin-bottom: 20px;
            text-align: center;
        }
        .case-box {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 3px 8px #00000022;
            margin-top: 15px;
        }
    </style>
</head>


<body class="bg">
<div class="layout">

    <!-- الهيدر -->
    <header class="top-header">
        <div class="top-header-right">
            <img src="labx.jpeg" class="logo-img">
            <div class="brand-text">
                <div class="brand-title">LABX DENTAL</div>
                <div class="brand-sub">استلام العيادة</div>
            </div>
        </div>

        <div class="top-header-left">
            <button onclick="window.location.href='index.html'"
                    class="btn-logout" style="background:#0f766e;">
                رجوع
            </button>
        </div>
    </header>


    <main class="main-card fade-in">

        <h2 style="text-align:center;margin-bottom:20px;">مسح QR لاستلام الحالة</h2>

        <!-- صندوق السحب -->
        <div class="scan-box">
            <div id="reader" style="width:250px;margin:auto;"></div>
        </div>

        <!-- معلومات الحالة -->
        <div id="caseData" class="case-box" style="display:none;"></div>

        <!-- ازرار الإجراءات -->
        <div id="actionButtons" style="display:none;margin-top:20px;">
            <label>اسم المساعدة المستلمة:</label>
            <input id="receivedBy" class="input" placeholder="اسم المساعدة">

            <label>رقم العيادة:</label>
            <input id="clinicNumber" class="input" placeholder="رقم العيادة">

            <button onclick="confirmReceive()" 
                    class="btn-logout"
                    style="background:#0f766e;margin-top:10px;width:100%;">
                ✔ تأكيد الاستلام
            </button>
        </div>

    </main>

</div>


<script>
// ---------------------------------------------------------
// جلب البيانات
// ---------------------------------------------------------
let cases = JSON.parse(localStorage.getItem("labxNewCases") || "[]");
let techList = JSON.parse(localStorage.getItem("techList") || "[]");

let techColors = {};
techList.forEach(t => techColors[t.name] = t.color);

let selectedCase = null;


// ---------------------------------------------------------
// QR Scan
// ---------------------------------------------------------
function onScanSuccess(decodedText) {

    let found = cases.find(c => c.qrValue === decodedText);

    if (!found) {
        alert("❌ لم يتم العثور على حالة بهذا الـ QR");
        return;
    }

    selectedCase = found;

    let color = techColors[found.technicianName] || "#0f766e";

    document.getElementById("caseData").innerHTML = `
        <h3 style="border-right:8px solid ${color};padding-right:10px;">${found.patientName}</h3>
        <p>رقم الملف: ${found.fileNumber}</p>
        <p>قسم الحالة: ${found.caseType}</p>
        <p>الفني: ${found.technicianName}</p>
        <p>تاريخ دخول المعمل: ${found.createdAt}</p>
        ${found.readyTime ? `<p style="color:#16a34a;">جاهزة منذ: ${found.readyTime}</p>` : ""}
    `;

    document.getElementById("caseData").style.display = "block";
    document.getElementById("actionButtons").style.display = "block";
}


// QR Initialization
let html5QrCode = new Html5Qrcode("reader");
Html5Qrcode.getCameras().then(devices => {
    if (devices && devices.length) {
        html5QrCode.start(
            devices[0].id,
            { fps: 10, qrbox: 200 },
            onScanSuccess
        );
    }
});


// ---------------------------------------------------------
// تأكيد استلام الحالة من العيادة
// ---------------------------------------------------------
function confirmReceive() {

    if (!selectedCase) return alert("❌ لم يتم مسح أي QR");

    let receivedBy = document.getElementById("receivedBy").value.trim();
    let clinicNo = document.getElementById("clinicNumber").value.trim();

    if (!receivedBy || !clinicNo) {
        alert("⚠ يرجى إدخال اسم المساعدة ورقم العيادة");
        return;
    }

    let index = cases.findIndex(c => c.id === selectedCase.id);
    if (index === -1) return;

    cases[index].status = "تم التسليم للعيادة";
    cases[index].receivedBy = receivedBy;
    cases[index].clinicNo = clinicNo;
    cases[index].receivedAt = new Date().toLocaleString();

    localStorage.setItem("labxNewCases", JSON.stringify(cases));

    alert("✔ تم تسليم الحالة للعيادة بنجاح");

    window.location.href = "index.html";
}

</script>

</body>
</html>
