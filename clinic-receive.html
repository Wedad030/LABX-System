<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>استلام الحالة - LABX</title>
  <link rel="stylesheet" href="style.css">

  <!-- QR Scanner -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    canvas {
      border: 1px solid #cbd5e1;
      background: #f1f5f9;
      border-radius: 12px;
      width: 100%;
      height: 200px;
      margin-top: 10px;
    }
  </style>
</head>

<body class="bg">

<div class="layout">

  <!-- الهيدر -->
  <header class="top-header">
    <div class="top-header-right">
      <img src="labx.jpeg" class="logo-img" alt="LABX Dental">
      <div class="brand-text">
        <div class="brand-title">LABX DENTAL</div>
        <div class="brand-sub">Clinic Receive</div>
      </div>
    </div>

    <div class="top-header-left">
      <button onclick="window.location.href='index.html'" class="btn-logout" style="background:#0f766e;">
        رجوع
      </button>
    </div>
  </header>

  <!-- المحتوى -->
  <main class="main-card fade-in">

    <h2 style="text-align:center;margin-bottom: 15px;">استلام الحالة في العيادة</h2>

    <h3>مسح QR</h3>
    <div id="reader" style="width:280px;margin:auto;"></div>

    <div id="caseInfo" style="display:none;margin-top:20px;">
      <h3>بيانات الحالة</h3>
      <p id="p_patient"></p>
      <p id="p_file"></p>
      <p id="p_tech"></p>
    </div>

    <label style="margin-top:20px;">اسم المساعدة:</label>
    <input id="assistant" class="input" placeholder="اسم الممرضة">

    <label>رقم العيادة:</label>
    <input id="clinic" class="input" placeholder="مثال: 4">

    <label style="margin-top:15px;">التوقيع:</label>
    <canvas id="signPad"></canvas>
    <button onclick="clearSign()" class="btn-logout" style="background:#dc2626;margin-top:6px;">
      مسح التوقيع
    </button>

    <button onclick="submitReceive()" class="btn-logout"
            style="background:#16a34a;margin-top:20px;width:100%;">
      تأكيد استلام الحالة ✔
    </button>

  </main>
</div>


<script>
let selectedCase = null;

// QR Scanner
function onScanSuccess(decodedText) {
  const allCases = JSON.parse(localStorage.getItem("labxNewCases") || "[]");
  const found = allCases.find(c => c.qrValue === decodedText);

  if (found) {
    selectedCase = found;

    document.getElementById("caseInfo").style.display = "block";
    document.getElementById("p_patient").innerText = "اسم المريض: " + found.patientName;
    document.getElementById("p_file").innerText = "رقم الملف: " + found.fileNumber;
    document.getElementById("p_tech").innerText = "الفني: " + found.technicianName;
  } else {
    alert("❌ لا توجد حالة بهذا QR");
  }
}

let scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 200 }, false);
scanner.render(onScanSuccess);


// التوقيع
const canvas = document.getElementById("signPad");
const ctx = canvas.getContext("2d");
let drawing = false;

canvas.addEventListener("mousedown", start);
canvas.addEventListener("mouseup", end);
canvas.addEventListener("mousemove", draw);

canvas.addEventListener("touchstart", (e) => start(e.touches[0]));
canvas.addEventListener("touchend", end);
canvas.addEventListener("touchmove", (e) => draw(e.touches[0]));

function start(e) {
  drawing = true;
  ctx.beginPath();
  ctx.moveTo(e.clientX - canvas.offsetLeft, e.clientY - canvas.offsetTop);
}

function end() {
  drawing = false;
}

function draw(e) {
  if (!drawing) return;
  ctx.strokeStyle = "#0f766e";
  ctx.lineWidth = 3;
  ctx.lineCap = "round";
  ctx.lineTo(e.clientX - canvas.offsetLeft, e.clientY - canvas.offsetTop);
  ctx.stroke();
}

function clearSign() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}


// حفظ الاستلام للعيادة
function submitReceive() {
  if (!selectedCase) {
    alert("⚠ يرجى مسح QR أولاً");
    return;
  }

  const assistant = document.getElementById("assistant").value.trim();
  const clinic = document.getElementById("clinic").value.trim();
  const signature = canvas.toDataURL();

  if (!assistant || !clinic) {
    alert("⚠ يرجى تعبئة جميع الحقول");
    return;
  }

  let allCases = JSON.parse(localStorage.getItem("labxNewCases") || "[]");
  const index = allCases.findIndex(c => c.id === selectedCase.id);

  if (index > -1) {
    allCases[index].clinicReceive = {
      assistant,
      clinic,
      signature,
      time: new Date().toLocaleString()
    };

    allCases[index].status = "تم التسليم للعيادة";
  }

  localStorage.setItem("labxNewCases", JSON.stringify(allCases));

  alert("✔ تم استلام الحالة بنجاح!");
  window.location.href = "index.html";
}
</script>

</body>
</html>
