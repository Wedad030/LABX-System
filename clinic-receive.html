<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© - LABX</title>
    <link rel="stylesheet" href="style.css">
    <style>
        #preview {
            width: 220px;
            margin: 10px auto;
            display: none;
        }
        #dataBox {
            background: #fff;
            padding: 18px;
            border-radius: 14px;
            box-shadow: 0 4px 18px rgba(0,0,0,0.1);
            margin-top: 15px;
            display: none;
        }
        .label {
            font-weight: bold;
            margin-top: 8px;
            color: #0f766e;
        }
    </style>
</head>

<body class="bg">

<script>
// Ø­Ù…Ø§ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
if (localStorage.getItem("labxLogged") !== "true") {
    window.location.href = "login.html";
}
</script>

<div class="layout">

    <!-- Ù‡ÙŠØ¯Ø± -->
    <header class="top-header">
        <div class="top-header-right">
            <img src="labx.jpeg" class="logo-img">
            <div class="brand-text">
                <div class="brand-title">LABX DENTAL</div>
                <div class="brand-sub">Clinic Receive</div>
            </div>
        </div>

        <div class="top-header-left">
            <button onclick="window.location.href='index.html'" class="btn-logout">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
    </header>


    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
    <main class="main-card fade-in">

        <h2 style="text-align:center;margin-bottom:15px;">ğŸ“² Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø¹Ù…Ù„</h2>

        <!-- QR Scanner -->
        <div style="text-align:center;">
            <video id="preview"></video>
            <button onclick="startScanner()" class="btn-logout" style="background:#0f766e;margin-bottom:10px;">
                ğŸ¥ ØªØ´ØºÙŠÙ„ Ù…Ø§Ø³Ø­ Ø§Ù„Ù€ QR
            </button>
        </div>

        <hr style="margin:15px 0; opacity:0.3;">

        <!-- Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠ -->
        <div>
            <label class="label">Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù:</label>
            <input id="searchFile" class="input" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù">
            <button onclick="searchManual()" class="btn-logout" style="background:#0f766e;margin-top:8px;">
                Ø¨Ø­Ø«
            </button>
        </div>

        <!-- Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© -->
        <div id="dataBox"></div>

    </main>

</div>

<!-- Firebase + QR Scanner -->
<script type="module">
import { db } from "./firebase.js";
import { 
    getDoc, doc, updateDoc, deleteDoc, setDoc, collection 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js";

const preview = document.getElementById("preview");
const dataBox = document.getElementById("dataBox");

let currentCaseId = null;



// ------------------------
// 1ï¸âƒ£ ØªØ´ØºÙŠÙ„ QR Scanner
// ------------------------
window.startScanner = function() {
    preview.style.display = "block";

    const scanner = new QrScanner(preview, result => {
        scanner.stop();
        preview.style.display = "none";
        fetchCaseByQR(result.data);
    });

    scanner.start();
};



// ------------------------
// 2ï¸âƒ£ Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù
// ------------------------
window.searchManual = async function() {
    const file = document.getElementById("searchFile").value.trim();
    if (!file) return alert("â— Ø£Ø¯Ø®Ù„ÙŠ Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù");

    fetchCaseByFile(file);
};



// ------------------------
// 3ï¸âƒ£ Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ù…Ù† Firebase Ø¨Ø§Ù„Ù€ QR
// ------------------------
async function fetchCaseByQR(qrValue) {
    const col = collection(db, "readyCases");
    const snapshot = await getDocs(col);

    let found = null;

    snapshot.forEach(docu => {
        if (docu.data().qrValue == qrValue) {
            found = { id: docu.id, ...docu.data() };
        }
    });

    if (!found) return alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù€ QR");

    showCase(found);
}



// ------------------------
// 4ï¸âƒ£ Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ù…Ù† Firebase Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù
// ------------------------
async function fetchCaseByFile(fileNumber) {
    const col = collection(db, "readyCases");
    const snapshot = await getDocs(col);

    let match = null;

    snapshot.forEach(docu => {
        if (docu.data().fileNumber == fileNumber) {
            match = { id: docu.id, ...docu.data() };
        }
    });

    if (!match) return alert("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…");

    showCase(match);
}



// ------------------------
// 5ï¸âƒ£ Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©
// ------------------------
function showCase(c) {
    currentCaseId = c.id;

    dataBox.style.display = "block";
    dataBox.innerHTML = `
        <h3>${c.patientName}</h3>
        <p>ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù: ${c.fileNumber}</p>
        <p>ğŸ¥ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©: ${c.clinicNumber}</p>
        <p>ğŸ‘¨â€ğŸ”§ Ø§Ù„ÙÙ†ÙŠ: ${c.technicianName}</p>

        <label class="label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©:</label>
        <input id="assistantReceive" class="input">

        <button onclick="confirmReceive()" class="btn-logout" 
            style="background:#0f766e;margin-top:12px;width:100%;">
            âœ“ ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø©
        </button>
    `;
}



// ------------------------
// 6ï¸âƒ£ ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©
// ------------------------
window.confirmReceive = async function() {
    const assistant = document.getElementById("assistantReceive").value;

    if (!assistant) return alert("â— Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©");

    const readyRef = doc(db, "readyCases", currentCaseId);
    const archiveRef = doc(db, "archive", currentCaseId);

    const snap = await getDoc(readyRef);

    if (!snap.exists()) return alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£.. Ø§Ù„Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");

    // Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
    await setDoc(archiveRef, {
        ...snap.data(),
        receivedAt: new Date().toLocaleString(),
        receivedBy: assistant,
        status: "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù„Ù„Ø¹ÙŠØ§Ø¯Ø©"
    });

    // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø¬Ø§Ù‡Ø²
    await deleteDoc(readyRef);

    alert("âœ” ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ø¹ÙŠØ§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­");

    window.location.href = "index.html";
};
</script>

</body>
</html>
